<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ TTS ë¦½ì‹±í¬ - ê·¸ë¦°ìŠ¤í¬ë¦°</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .main-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            padding: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1400px;
            width: 100%;
        }

        .canvas-container {
            background: rgba(42, 42, 42, 0.8);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }

        #greenscreenCanvas {
            display: block;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 255, 0, 0.4);
            border: 3px solid rgba(0, 255, 0, 0.3);
        }

        .canvas-info {
            margin-top: 15px;
            text-align: center;
            color: #00ff88;
            font-size: 15px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 35px;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            max-width: 500px;
            width: 100%;
        }

        .controls h2 {
            margin: 0 0 25px 0;
            color: #1a1a2e;
            font-size: 28px;
            text-align: center;
            font-weight: 800;
        }

        .section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 12px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #00ff88;
        }

        button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            margin: 6px;
            transition: all 0.3s;
            font-weight: 700;
            width: calc(50% - 12px);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .full-button {
            width: 100% !important;
            margin: 6px 0 !important;
        }

        .recording-btn {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .recording-btn.recording {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .audio-recording-btn {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);
        }

        .audio-recording-btn.recording {
            background: linear-gradient(135deg, #ffaa33 0%, #ff9500 100%);
            animation: pulse-orange 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(255, 68, 68, 0.6); }
        }

        @keyframes pulse-orange {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(255, 149, 0, 0.6); }
        }

        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .status {
            margin-top: 15px;
            padding: 14px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            font-weight: 600;
        }

        .status.speaking {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }

        .status.idle {
            background: #f8f9fa;
            color: #6c757d;
        }

        .status.recording {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }

        .status.audio-recording {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }

        .info {
            padding: 15px;
            background: linear-gradient(135deg, #e7f3ff 0%, #dae9f7 100%);
            border-radius: 12px;
            font-size: 13px;
            color: #004085;
            line-height: 1.8;
            border-left: 4px solid #0066cc;
        }

        .info strong {
            color: #003366;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .color-picker label {
            font-size: 15px;
            color: #555;
            font-weight: 600;
        }

        .color-picker input[type="color"] {
            width: 70px;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
        }

        .slider-container {
            margin: 12px 0;
        }

        .slider-container label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.4);
        }

        .audio-visualizer {
            width: 100%;
            height: 60px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .audio-visualizer canvas {
            width: 100%;
            height: 100%;
        }

        .file-upload {
            margin-top: 12px;
        }

        .file-upload input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed #00ff88;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            background: rgba(0, 255, 136, 0.05);
            transition: all 0.3s;
        }

        .file-upload input[type="file"]:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00cc6a;
        }

        .grid-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .grid-settings label {
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }

        .grid-settings input {
            margin-top: 6px;
        }

        .preview-grid {
            display: grid;
            gap: 8px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 12px;
            max-height: 280px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
        }

        .preview-grid::-webkit-scrollbar {
            width: 8px;
        }

        .preview-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .preview-grid::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }

        .preview-mouth {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            position: relative;
            transition: all 0.2s;
        }

        .preview-mouth:hover {
            border-color: #00ff88;
            transform: scale(1.05);
        }

        .preview-mouth.selected {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        }

        .mouth-label {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .phoneme-mapping {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-top: 12px;
            border: 2px solid #e0e0e0;
        }

        .phoneme-mapping h4 {
            margin: 0 0 12px 0;
            font-size: 15px;
            color: #333;
            font-weight: 700;
        }

        .phoneme-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 12px;
        }

        .phoneme-item select {
            flex: 1;
            padding: 8px;
            font-size: 13px;
            margin: 0;
        }

        .phoneme-item label {
            min-width: 100px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        .preset-btn {
            width: auto !important;
            padding: 10px 20px !important;
            font-size: 14px !important;
        }

        .speed-control {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .speed-btn {
            flex: 1;
            padding: 8px !important;
            font-size: 13px !important;
            width: auto !important;
            margin: 0 !important;
        }

        .speed-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="canvas-container">
            <canvas id="greenscreenCanvas" width="800" height="600"></canvas>
            <div class="canvas-info">ğŸ¬ ì¤€ë¹„ ì™„ë£Œ</div>
        </div>

        <div class="controls">
            <h2>ğŸ¤ í•œêµ­ì–´ TTS ë¦½ì‹±í¬</h2>

            <div class="section">
                <h3>ğŸ–¼ï¸ ì… ëª¨ì–‘ ì´ë¯¸ì§€</h3>
                <div class="file-upload">
                    <input type="file" id="mouthImageUpload" accept="image/*" onchange="loadMouthImage(event)">
                </div>
                <div class="grid-settings">
                    <label>
                        ì—´ (ê°€ë¡œ):
                        <input type="number" id="gridCols" min="1" max="10" value="4" onchange="updateGrid()">
                    </label>
                    <label>
                        í–‰ (ì„¸ë¡œ):
                        <input type="number" id="gridRows" min="1" max="10" value="5" onchange="updateGrid()">
                    </label>
                </div>
                <div id="previewGrid" class="preview-grid" style="display:none;"></div>
            </div>

            <div class="section" id="phonemeMappingSection" style="display:none;">
                <h3>ğŸ—£ï¸ ë°œìŒ ë§¤í•‘</h3>
                <div class="phoneme-mapping" id="phonemeMapping"></div>
            </div>

            <div class="section">
                <h3>ğŸ’¬ ëŒ€ì‚¬</h3>
                <textarea id="textInput" placeholder="ë§í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì°¸ ì¢‹ë„¤ìš”. ë°œìŒì— ë”°ë¼ ì… ëª¨ì–‘ì´ ë°”ë€ë‹ˆë‹¤.</textarea>
            </div>

            <div class="section">
                <h3>ğŸ”Š ìŒì„±</h3>
                <select id="voiceSelect">
                    <option value="">ìŒì„± ë¡œë”© ì¤‘...</option>
                </select>
                <button onclick="loadVoices(); alert('ìŒì„± ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤!');" class="full-button" style="background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); padding: 10px; font-size: 14px; margin-top: 8px;">ğŸ”„ ìŒì„± ìƒˆë¡œê³ ì¹¨</button>
                <div class="speed-control">
                    <button class="speed-btn" onclick="setSpeed(0.8)">ëŠë¦¬ê²Œ</button>
                    <button class="speed-btn active" onclick="setSpeed(1.0)">ë³´í†µ</button>
                    <button class="speed-btn" onclick="setSpeed(1.2)">ë¹ ë¥´ê²Œ</button>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ™ï¸ ìŒì„± ë…¹ìŒ</h3>
                <div class="button-row">
                    <button id="audioRecordBtn" class="audio-recording-btn full-button" onclick="toggleAudioRecording()">
                        ğŸ¤ ìŒì„± ë…¹ìŒ ì‹œì‘
                    </button>
                </div>
                <div id="audioVisualizer" class="audio-visualizer" style="display: none;">
                    <canvas id="visualizerCanvas"></canvas>
                </div>
                <div class="info" style="margin-top: 10px;">
                    <strong>ğŸ’¡ ì‚¬ìš©ë²•:</strong> ìŒì„± ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ˆì´í¬ë¡œ ë§í•œ í›„, ì¤‘ì§€í•˜ë©´ ìë™ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="section">
                <h3>ğŸ¨ ë°°ê²½</h3>
                <div class="color-picker">
                    <label>ë°°ê²½ìƒ‰:</label>
                    <input type="color" id="bgColor" value="#00ff00">
                    <button class="preset-btn" onclick="setPresetColor('#00ff00')">ğŸŸ¢ ê·¸ë¦°</button>
                    <button class="preset-btn" onclick="setPresetColor('#0000ff')" style="background: linear-gradient(135deg, #0066ff 0%, #0044cc 100%);">ğŸ”µ ë¸”ë£¨</button>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ“ í¬ê¸°</h3>
                <div class="slider-container">
                    <label>ì… í¬ê¸°: <span id="sizeValue">2.0</span>x</label>
                    <input type="range" id="mouthSize" min="0.5" max="4" step="0.1" value="2.0" oninput="updateMouthSize()">
                </div>
            </div>

            <div class="section">
                <h3>â–¶ï¸ ì¬ìƒ</h3>
                <div class="button-row">
                    <button id="speakBtn" onclick="speak()">ğŸ—£ï¸ ë§í•˜ê¸°</button>
                    <button id="stopBtn" onclick="stop()" disabled>â¹ï¸ ì •ì§€</button>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ¥ ë…¹í™”</h3>
                <button id="recordBtn" class="recording-btn full-button" onclick="toggleRecording()">âºï¸ ë…¹í™” ì‹œì‘</button>
                <button id="downloadBtn" class="download-btn full-button" onclick="downloadVideo()" disabled style="display:none;">ğŸ’¾ ì˜ìƒ ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div id="status" class="status idle">ì… ëª¨ì–‘ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>

            <div class="info">
                <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</strong><br>
                1ï¸âƒ£ ì… ëª¨ì–‘ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œíŠ¸ ì—…ë¡œë“œ<br>
                2ï¸âƒ£ ê²©ì í¬ê¸° ì„¤ì • (ìë™ ë¶„í• )<br>
                3ï¸âƒ£ ë°œìŒë³„ ì… ëª¨ì–‘ ìë™ ë§¤í•‘<br>
                4ï¸âƒ£ <strong>í•œêµ­ì–´ ìŒì„± ì„ íƒ</strong> (ì¤‘ìš”!)<br>
                5ï¸âƒ£ ëŒ€ì‚¬ ì…ë ¥ í›„ ë§í•˜ê¸°!<br>
                <br>
                <strong>âŒ¨ï¸ ë‹¨ì¶•í‚¤:</strong> Ctrl+Enter = ë§í•˜ê¸°<br>
                <br>
                <strong>ğŸ”Š TTS ì°¸ê³ :</strong><br>
                â€¢ ë¸Œë¼ìš°ì €ë§ˆë‹¤ ì§€ì›í•˜ëŠ” ìŒì„±ì´ ë‹¤ë¦…ë‹ˆë‹¤<br>
                â€¢ Chrome/EdgeëŠ” í•œêµ­ì–´ ìŒì„± ì§€ì› ìš°ìˆ˜<br>
                â€¢ ìŒì„±ì´ ì•ˆ ë“¤ë¦¬ë©´ 'ìŒì„± ìƒˆë¡œê³ ì¹¨' í´ë¦­<br>
                â€¢ F12 ì½˜ì†”ì—ì„œ ë””ë²„ê·¸ ì •ë³´ í™•ì¸ ê°€ëŠ¥
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('greenscreenCanvas');
        const ctx = canvas.getContext('2d');
        
        let synth = window.speechSynthesis;
        let utterance = null;
        let voices = [];
        let speechRate = 1.0;
        let mouthScale = 2.0;
        
        let mouthSpriteSheet = null;
        let mouthFrames = [];
        let currentMouthIndex = 0;
        let rows = 5;
        let cols = 4;
        
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let isSpeaking = false;
        let animationInterval = null;

        // ì˜¤ë””ì˜¤ ë…¹ìŒ ê´€ë ¨ ë³€ìˆ˜
        let isAudioRecording = false;
        let audioRecorder = null;
        let audioChunks = [];
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let animationFrameId = null;

        // ë°œìŒ ë§¤í•‘ (ì¸ë±ìŠ¤ ê¸°ë°˜) - ë” ì •í™•í•œ ë§¤í•‘
        let phonemeMap = {
            'rest': 0,          // ì‰¬ëŠ” ìƒíƒœ (ì… ë‹«í˜)
            'a': 4,             // ã…, ã…‘ (í¬ê²Œ ë²Œë¦° ì…)
            'ae': 5,            // ã…, ã…’ (ì•½ê°„ ë²Œë¦° ì…)
            'eo': 6,            // ã…“, ã…• (ì¤‘ê°„ ë²Œë¦° ì…)
            'e': 7,             // ã…”, ã…– (ì‘ê²Œ ë²Œë¦° ì…)
            'o': 8,             // ã…—, ã…› (ë‘¥ê·¼ ì… ì‘ê²Œ)
            'u': 9,             // ã…œ, ã…  (ë‘¥ê·¼ ì… í¬ê²Œ)
            'eu': 10,           // ã…¡ (ì˜†ìœ¼ë¡œ ë²Œë¦°)
            'i': 11,            // ã…£ (ì˜†ìœ¼ë¡œ ì¢ê²Œ)
            'b_p_m': 12,        // ã…‚, ã…ƒ, ã…, ã… (ì… ë‹¤ë¬¸)
            'n': 13,            // ã„´, ã„¹ (í˜€ ìœ„ì¹˜)
            's': 14,            // ã……, ã…† (ì´ ì‚´ì§ ë³´ì„)
            't_d': 15,          // ã…Œ, ã„·, ã„¸ (í˜€ ì•)
            'g_k': 16,          // ã„±, ã„², ã…‹ (ëª© ë°œìŒ)
            'j': 17,            // ã…ˆ, ã…‰, ã…Š (ì…ìˆ  ì•)
            'h': 18,            // ã… (í¬ê²Œ ë²Œë¦¼)
            'ng': 19            // ã…‡ (ëª© ë°œìŒ)
        };

        // í•œê¸€ ìëª¨ ë¶„í•´
        function decomposeHangul(char) {
            const code = char.charCodeAt(0);
            if (code < 0xAC00 || code > 0xD7A3) return null;
            
            const syllableIndex = code - 0xAC00;
            const jongIndex = syllableIndex % 28;
            const jungIndex = Math.floor((syllableIndex - jongIndex) / 28) % 21;
            const choIndex = Math.floor((syllableIndex - jongIndex) / 28 / 21);
            
            const cho = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const jung = ['ã…','ã…','ã…‘','ã…’','ã…“','ã…”','ã…•','ã…–','ã…—','ã…˜','ã…™','ã…š','ã…›','ã…œ','ã…','ã…','ã…Ÿ','ã… ','ã…¡','ã…¢','ã…£'];
            const jong = ['','ã„±','ã„²','ã„³','ã„´','ã„µ','ã„¶','ã„·','ã„¹','ã„º','ã„»','ã„¼','ã„½','ã„¾','ã„¿','ã…€','ã…','ã…‚','ã…„','ã……','ã…†','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            
            return {
                cho: cho[choIndex],
                jung: jung[jungIndex],
                jong: jong[jongIndex]
            };
        }

        // ìëª¨ì—ì„œ ë°œìŒ ì¶”ì¶œ - ë” ì„¸ë°€í•˜ê²Œ
        function getPhonemeFromJamo(jamo, isJong = false) {
            // ëª¨ìŒ
            const vowelMap = {
                'ã…': 'a', 'ã…‘': 'a',           // í¬ê²Œ ë²Œë¦° ì•„
                'ã…': 'ae', 'ã…’': 'ae',         // ì•½ê°„ ë²Œë¦° ì• 
                'ã…“': 'eo', 'ã…•': 'eo',         // ì¤‘ê°„ ë²Œë¦° ì–´
                'ã…”': 'e', 'ã…–': 'e',           // ì‘ê²Œ ë²Œë¦° ì—
                'ã…—': 'o', 'ã…›': 'o',           // ë‘¥ê·¼ ì… ì‘ê²Œ ì˜¤
                'ã…˜': 'o', 'ã…™': 'ae', 'ã…š': 'o',
                'ã…œ': 'u', 'ã… ': 'u',           // ë‘¥ê·¼ ì… í¬ê²Œ ìš°
                'ã…': 'u', 'ã…': 'e', 'ã…Ÿ': 'u',
                'ã…¡': 'eu',                      // ì˜†ìœ¼ë¡œ ë²Œë¦° ìœ¼
                'ã…¢': 'eu',
                'ã…£': 'i'                        // ì˜†ìœ¼ë¡œ ì¢ê²Œ ì´
            };
            
            // ììŒ (ì´ˆì„±)
            const consonantMap = {
                'ã…‚': 'b_p_m', 'ã…ƒ': 'b_p_m', 'ã…': 'b_p_m',
                'ã…': 'b_p_m',
                'ã„´': 'n', 'ã„¹': 'n',
                'ã……': 's', 'ã…†': 's',
                'ã…Œ': 't_d', 'ã„·': 't_d', 'ã„¸': 't_d',
                'ã„±': 'g_k', 'ã„²': 'g_k', 'ã…‹': 'g_k',
                'ã…ˆ': 'j', 'ã…‰': 'j', 'ã…Š': 'j',
                'ã…': 'h',
                'ã…‡': isJong ? 'ng' : null  // ì´ˆì„± ã…‡ì€ ë¬´ìŒ
            };
            
            // ì¢…ì„± ììŒ (ë°›ì¹¨)
            const jongConsonantMap = {
                'ã„±': 'g_k', 'ã„²': 'g_k', 'ã„³': 'g_k',
                'ã„´': 'n', 'ã„µ': 'n', 'ã„¶': 'n',
                'ã„·': 't_d', 'ã„¹': 'n',
                'ã„º': 'g_k', 'ã„»': 'b_p_m', 'ã„¼': 'b_p_m',
                'ã„½': 's', 'ã„¾': 't_d', 'ã„¿': 'b_p_m', 'ã…€': 'n',
                'ã…': 'b_p_m',
                'ã…‚': 'b_p_m', 'ã…„': 'b_p_m',
                'ã……': 't_d', 'ã…†': 't_d',
                'ã…‡': 'ng',
                'ã…ˆ': 't_d', 'ã…Š': 't_d',
                'ã…‹': 'g_k', 'ã…Œ': 't_d', 'ã…': 'b_p_m', 'ã…': 't_d'
            };
            
            if (vowelMap[jamo]) return vowelMap[jamo];
            if (isJong && jongConsonantMap[jamo]) return jongConsonantMap[jamo];
            if (consonantMap[jamo]) return consonantMap[jamo];
            
            return 'rest';
        }

        // í…ìŠ¤íŠ¸ë¥¼ ë°œìŒ ì‹œí€€ìŠ¤ë¡œ ë³€í™˜ - ë” ìì—°ìŠ¤ëŸ½ê²Œ
        function textToPhonemes(text) {
            const phonemes = [];
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                
                // ê³µë°±ê³¼ êµ¬ë‘ì 
                if (char === ' ') {
                    phonemes.push({ phoneme: 'rest', duration: 150 });
                    continue;
                } else if (char === ',' || char === '.') {
                    phonemes.push({ phoneme: 'rest', duration: 250 });
                    continue;
                } else if (char === '!' || char === '?') {
                    phonemes.push({ phoneme: 'rest', duration: 300 });
                    continue;
                }
                
                const decomposed = decomposeHangul(char);
                if (!decomposed) {
                    phonemes.push({ phoneme: 'rest', duration: 100 });
                    continue;
                }
                
                // ì´ˆì„± (ììŒ)
                if (decomposed.cho && decomposed.cho !== 'ã…‡') {
                    const choPhoneme = getPhonemeFromJamo(decomposed.cho, false);
                    if (choPhoneme) {
                        phonemes.push({
                            phoneme: choPhoneme,
                            duration: 60  // ììŒì€ ì§§ê²Œ
                        });
                    }
                }
                
                // ì¤‘ì„± (ëª¨ìŒ) - ê°€ì¥ ì¤‘ìš”, ê¸¸ê²Œ
                const jungPhoneme = getPhonemeFromJamo(decomposed.jung, false);
                phonemes.push({
                    phoneme: jungPhoneme,
                    duration: 180  // ëª¨ìŒì€ ê¸¸ê²Œ
                });
                
                // ì¢…ì„± (ë°›ì¹¨)
                if (decomposed.jong) {
                    const jongPhoneme = getPhonemeFromJamo(decomposed.jong, true);
                    if (jongPhoneme) {
                        // ë‹¤ìŒ ê¸€ìê°€ ìˆê³  ì´ˆì„±ì´ ã…‡ì´ë©´ ì—°ìŒ
                        const nextChar = text[i + 1];
                        const nextDecomposed = nextChar ? decomposeHangul(nextChar) : null;
                        
                        if (nextDecomposed && nextDecomposed.cho === 'ã…‡') {
                            // ì—°ìŒ - ì¢…ì„±ì„ ì§§ê²Œ í•˜ê³  ë‹¤ìŒ ìŒì ˆë¡œ ì´ì–´ì§
                            phonemes.push({
                                phoneme: jongPhoneme,
                                duration: 40
                            });
                        } else {
                            // ì¼ë°˜ ì¢…ì„±
                            phonemes.push({
                                phoneme: jongPhoneme,
                                duration: 80
                            });
                        }
                    }
                }
                
                // ìŒì ˆ ì‚¬ì´ ë¯¸ì„¸í•œ ê°„ê²©
                if (i < text.length - 1 && text[i + 1] !== ' ') {
                    phonemes.push({ phoneme: 'rest', duration: 20 });
                }
            }
            
            return phonemes;
        }

        // ë¦½ì‹±í¬ ì• ë‹ˆë©”ì´ì…˜
        function animateLipSync(text) {
            const phonemeSequence = textToPhonemes(text);
            let index = 0;
            
            function nextPhoneme() {
                if (!isSpeaking || index >= phonemeSequence.length) {
                    currentMouthIndex = phonemeMap['rest'];
                    drawCurrentMouth();
                    return;
                }
                
                const { phoneme, duration } = phonemeSequence[index];
                currentMouthIndex = phonemeMap[phoneme] || phonemeMap['rest'];
                drawCurrentMouth();
                
                index++;
                animationInterval = setTimeout(nextPhoneme, duration / speechRate);
            }
            
            nextPhoneme();
        }

        function loadMouthImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    mouthSpriteSheet = img;
                    updateGrid();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateGrid() {
            rows = parseInt(document.getElementById('gridRows').value);
            cols = parseInt(document.getElementById('gridCols').value);
            
            if (mouthSpriteSheet) {
                extractMouthFrames();
                displayPreviewGrid();
                displayPhonemeMapping();
                drawCurrentMouth();
                updateStatus('âœ… ì¤€ë¹„ ì™„ë£Œ! ë§í•˜ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.', 'idle');
            }
        }

        // ì´ë¯¸ì§€ì—ì„œ ì‹¤ì œ ì…ì´ ìˆëŠ” ì˜ì—­ ê°ì§€
        function detectMouthBounds(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let minX = canvas.width;
            let minY = canvas.height;
            let maxX = 0;
            let maxY = 0;
            
            // íˆ¬ëª…í•˜ì§€ ì•Šì€ í”½ì…€ ì°¾ê¸°
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const idx = (y * canvas.width + x) * 4;
                    const alpha = data[idx + 3];
                    
                    // ì™„ì „ íˆ¬ëª…í•˜ì§€ ì•Šê³ , í°ìƒ‰ì´ ì•„ë‹Œ í”½ì…€ (ì‹¤ì œ ì… ë¶€ë¶„)
                    if (alpha > 10) {
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        
                        // ê±°ì˜ í°ìƒ‰ì´ ì•„ë‹Œ ê²½ìš°ë§Œ (ì… ë¶€ë¶„)
                        if (r < 240 || g < 240 || b < 240) {
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                }
            }
            
            // ìœ íš¨í•œ ì˜ì—­ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì „ì²´ ì˜ì—­ ë°˜í™˜
            if (minX >= maxX || minY >= maxY) {
                return { x: 0, y: 0, width: canvas.width, height: canvas.height };
            }
            
            // ì•½ê°„ì˜ íŒ¨ë”© ì¶”ê°€
            const padding = 5;
            minX = Math.max(0, minX - padding);
            minY = Math.max(0, minY - padding);
            maxX = Math.min(canvas.width, maxX + padding);
            maxY = Math.min(canvas.height, maxY + padding);
            
            return {
                x: minX,
                y: minY,
                width: maxX - minX,
                height: maxY - minY,
                centerX: (minX + maxX) / 2,
                centerY: (minY + maxY) / 2
            };
        }

        function extractMouthFrames() {
            if (!mouthSpriteSheet) return;
            
            mouthFrames = [];
            const frameWidth = mouthSpriteSheet.width / cols;
            const frameHeight = mouthSpriteSheet.height / rows;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = frameWidth;
                    tempCanvas.height = frameHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCtx.drawImage(
                        mouthSpriteSheet,
                        col * frameWidth,
                        row * frameHeight,
                        frameWidth,
                        frameHeight,
                        0, 0,
                        frameWidth,
                        frameHeight
                    );
                    
                    // ì… ì˜ì—­ ê°ì§€
                    const bounds = detectMouthBounds(tempCanvas);
                    
                    mouthFrames.push({
                        canvas: tempCanvas,
                        bounds: bounds
                    });
                }
            }
        }

        function displayPreviewGrid() {
            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';
            previewGrid.style.display = 'grid';
            previewGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            mouthFrames.forEach((frame, index) => {
                const container = document.createElement('div');
                container.style.position = 'relative';
                
                const img = document.createElement('img');
                img.src = frame.canvas.toDataURL();
                img.className = 'preview-mouth';
                if (index === currentMouthIndex) {
                    img.classList.add('selected');
                }
                img.onclick = () => {
                    document.querySelectorAll('.preview-mouth').forEach(m => m.classList.remove('selected'));
                    img.classList.add('selected');
                    currentMouthIndex = index;
                    drawCurrentMouth();
                };
                
                const label = document.createElement('div');
                label.className = 'mouth-label';
                label.textContent = index;
                
                container.appendChild(img);
                container.appendChild(label);
                previewGrid.appendChild(container);
            });
        }

        function displayPhonemeMapping() {
            const section = document.getElementById('phonemeMappingSection');
            const mapping = document.getElementById('phonemeMapping');
            section.style.display = 'block';
            
            const labels = {
                'rest': 'ğŸ˜Œ ì‰¬ëŠ” ìƒíƒœ (ì… ë‹«í˜)',
                'a': 'ğŸ˜® ã…/ã…‘ (í¬ê²Œ ë²Œë¦¼)',
                'ae': 'ğŸ˜ƒ ã…/ã…’ (ì•½ê°„ ë²Œë¦¼)',
                'eo': 'ğŸ˜¯ ã…“/ã…• (ì¤‘ê°„ ë²Œë¦¼)',
                'e': 'ğŸ™‚ ã…”/ã…– (ì‘ê²Œ ë²Œë¦¼)',
                'o': 'ğŸ˜— ã…—/ã…› (ë‘¥ê·¼ ì‘ê²Œ)',
                'u': 'ğŸ˜™ ã…œ/ã…  (ë‘¥ê·¼ í¬ê²Œ)',
                'eu': 'ğŸ˜¬ ã…¡ (ì˜†ìœ¼ë¡œ)',
                'i': 'ğŸ˜ ã…£ (ì¢ê²Œ)',
                'b_p_m': 'ğŸ¤ ã…‚/ã…ƒ/ã…/ã…',
                'n': 'ğŸ˜› ã„´/ã„¹',
                's': 'ğŸ˜¬ ã……/ã…†',
                't_d': 'ğŸ˜‘ ã…Œ/ã„·/ã„¸',
                'g_k': 'ğŸ˜® ã„±/ã„²/ã…‹',
                'j': 'ğŸ˜ ã…ˆ/ã…‰/ã…Š',
                'h': 'ğŸ˜² ã… (í¬ê²Œ)',
                'ng': 'ğŸ˜® ã…‡ (ë°›ì¹¨)'
            };
            
            mapping.innerHTML = '<h4>ğŸ¯ ë°œìŒë³„ ì… ëª¨ì–‘ (ì„¸ë°€ ì„¤ì •):</h4>';
            
            for (let [key, label] of Object.entries(labels)) {
                const item = document.createElement('div');
                item.className = 'phoneme-item';
                
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                
                const select = document.createElement('select');
                for (let i = 0; i < mouthFrames.length; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `ì…ëª¨ì–‘ ${i}`;
                    if (i === phonemeMap[key]) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
                select.onchange = (e) => {
                    phonemeMap[key] = parseInt(e.target.value);
                };
                
                item.appendChild(labelEl);
                item.appendChild(select);
                mapping.appendChild(item);
            }
        }

        function drawCurrentMouth() {
            if (mouthFrames.length === 0) {
                const bgColor = document.getElementById('bgColor').value;
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                return;
            }
            
            const bgColor = document.getElementById('bgColor').value;
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const frameData = mouthFrames[currentMouthIndex];
            const frame = frameData.canvas;
            const bounds = frameData.bounds;
            const scale = mouthScale;
            
            // ì… ì˜ì—­ì˜ ì¤‘ì‹¬ì„ ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ë°°ì¹˜
            const scaledWidth = bounds.width * scale;
            const scaledHeight = bounds.height * scale;
            
            // ì…ì˜ ì¤‘ì‹¬ì ì„ ìº”ë²„ìŠ¤ ì¤‘ì‹¬ìœ¼ë¡œ
            const destX = (canvas.width / 2) - (bounds.centerX * scale);
            const destY = (canvas.height / 2) - (bounds.centerY * scale);
            
            // ì „ì²´ í”„ë ˆì„ì„ ê·¸ë¦¬ë˜, ì…ì˜ ì¤‘ì‹¬ì´ ìº”ë²„ìŠ¤ ì¤‘ì‹¬ì— ì˜¤ë„ë¡
            ctx.drawImage(
                frame,
                destX,
                destY,
                frame.width * scale,
                frame.height * scale
            );
        }

        function updateMouthSize() {
            const slider = document.getElementById('mouthSize');
            mouthScale = parseFloat(slider.value);
            document.getElementById('sizeValue').textContent = mouthScale.toFixed(1);
            drawCurrentMouth();
        }

        function setPresetColor(color) {
            document.getElementById('bgColor').value = color;
            drawCurrentMouth();
        }

        function setSpeed(speed) {
            speechRate = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        document.getElementById('bgColor').addEventListener('input', drawCurrentMouth);

        function loadVoices() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            
            // í•œêµ­ì–´ ìŒì„± í•„í„°ë§ (ko-KR, ko_KR, ko í¬í•¨)
            const koreanVoices = voices.filter(v => 
                v.lang.toLowerCase().includes('ko') || 
                v.name.toLowerCase().includes('korean') ||
                v.name.toLowerCase().includes('í•œêµ­')
            );
            const otherVoices = voices.filter(v => 
                !v.lang.toLowerCase().includes('ko') && 
                !v.name.toLowerCase().includes('korean') &&
                !v.name.toLowerCase().includes('í•œêµ­')
            );
            
            if (koreanVoices.length > 0) {
                const group = document.createElement('optgroup');
                group.label = 'ğŸ‡°ğŸ‡· í•œêµ­ì–´ ìŒì„±';
                koreanVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.default || voice.localService) {
                        option.textContent += ' â­';
                    }
                    group.appendChild(option);
                });
                voiceSelect.appendChild(group);
                
                // ì²« ë²ˆì§¸ í•œêµ­ì–´ ìŒì„±ì„ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒ
                voiceSelect.value = voices.indexOf(koreanVoices[0]);
            } else {
                // í•œêµ­ì–´ ìŒì„±ì´ ì—†ëŠ” ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
                const option = document.createElement('option');
                option.textContent = 'âš ï¸ í•œêµ­ì–´ ìŒì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                option.disabled = true;
                voiceSelect.appendChild(option);
            }
            
            if (otherVoices.length > 0) {
                const group = document.createElement('optgroup');
                group.label = 'ğŸŒ ê¸°íƒ€ ì–¸ì–´';
                otherVoices.slice(0, 10).forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    group.appendChild(option);
                });
                voiceSelect.appendChild(group);
            }
            
            // ë””ë²„ê·¸: ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„± ì¶œë ¥
            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„±:', voices.length + 'ê°œ');
            console.log('í•œêµ­ì–´ ìŒì„±:', koreanVoices.length + 'ê°œ');
            if (koreanVoices.length > 0) {
                console.log('ì„ íƒëœ í•œêµ­ì–´ ìŒì„±:', koreanVoices[0].name);
            }
        }

        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        
        // ì´ˆê¸° ë¡œë“œ
        loadVoices();
        
        // 1ì´ˆ í›„ ì¬ì‹œë„ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ í•„ìš”)
        setTimeout(() => {
            if (voices.length === 0) {
                console.log('ìŒì„± ì¬ë¡œë“œ ì‹œë„...');
                loadVoices();
            }
        }, 1000);
        
        // 3ì´ˆ í›„ ìµœì¢… ì¬ì‹œë„
        setTimeout(() => {
            if (voices.length === 0) {
                console.log('ìµœì¢… ìŒì„± ë¡œë“œ ì‹œë„...');
                voices = synth.getVoices();
                loadVoices();
            }
        }, 3000);

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            if (mouthFrames.length === 0) {
                alert('ë¨¼ì € ì… ëª¨ì–‘ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            try {
                const stream = canvas.captureStream(30);
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 8000000
                });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    const downloadBtn = document.getElementById('downloadBtn');
                    downloadBtn.style.display = 'block';
                    downloadBtn.disabled = false;
                    downloadBtn.onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `lipsync_${Date.now()}.webm`;
                        a.click();
                    };
                    
                    updateStatus('âœ… ë…¹í™” ì™„ë£Œ! ì˜ìƒì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.', 'idle');
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.textContent = 'â¹ï¸ ë…¹í™” ì¤‘ì§€';
                recordBtn.classList.add('recording');
                
                updateStatus('ğŸ”´ ë…¹í™” ì¤‘...', 'recording');
                
            } catch (error) {
                console.error('ë…¹í™” ì‹¤íŒ¨:', error);
                alert('ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.textContent = 'âºï¸ ë…¹í™” ì‹œì‘';
                recordBtn.classList.remove('recording');
            }
        }

        function speak() {
            if (mouthFrames.length === 0) {
                alert('ë¨¼ì € ì… ëª¨ì–‘ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            stop();

            // ìŒì„± ë‹¤ì‹œ ë¡œë“œ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ í•„ìš”)
            if (voices.length === 0) {
                voices = synth.getVoices();
            }

            utterance = new SpeechSynthesisUtterance(text);
            
            // ì„ íƒëœ ìŒì„± ì ìš©
            const selectedVoiceIndex = document.getElementById('voiceSelect').value;
            if (selectedVoiceIndex !== '' && voices[selectedVoiceIndex]) {
                utterance.voice = voices[selectedVoiceIndex];
                console.log('ì‚¬ìš© ì¤‘ì¸ ìŒì„±:', voices[selectedVoiceIndex].name);
            } else {
                // ìŒì„±ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° í•œêµ­ì–´ ìŒì„± ì°¾ê¸°
                const koreanVoice = voices.find(v => 
                    v.lang.toLowerCase().includes('ko') || 
                    v.name.toLowerCase().includes('korean')
                );
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                    console.log('ìë™ ì„ íƒëœ í•œêµ­ì–´ ìŒì„±:', koreanVoice.name);
                }
            }
            
            // í•œêµ­ì–´ ì„¤ì • ê°•ì œ
            utterance.lang = 'ko-KR';
            utterance.rate = speechRate;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            utterance.onstart = () => {
                isSpeaking = true;
                updateStatus('ğŸ—£ï¸ ë§í•˜ëŠ” ì¤‘...', 'speaking');
                document.getElementById('speakBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                console.log('TTS ì‹œì‘:', {
                    text: text.substring(0, 20) + '...',
                    voice: utterance.voice ? utterance.voice.name : 'ê¸°ë³¸',
                    lang: utterance.lang,
                    rate: utterance.rate
                });
                
                animateLipSync(text);
            };

            utterance.onend = () => {
                console.log('TTS ì™„ë£Œ');
                isSpeaking = false;
                setTimeout(() => {
                    stop();
                    if (isRecording) {
                        setTimeout(() => stopRecording(), 500);
                    }
                }, 300);
            };

            utterance.onerror = (event) => {
                console.error('TTS ì˜¤ë¥˜:', event);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', {
                    error: event.error,
                    message: event.message,
                    voice: utterance.voice ? utterance.voice.name : 'none'
                });
                
                stop();
                
                let errorMsg = 'ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (event.error === 'network') {
                    errorMsg += '\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (event.error === 'synthesis-failed') {
                    errorMsg += '\në‹¤ë¥¸ ìŒì„±ì„ ì„ íƒí•´ë³´ì„¸ìš”.';
                } else if (event.error === 'not-allowed') {
                    errorMsg += '\në¸Œë¼ìš°ì €ì—ì„œ ìŒì„± ì¬ìƒì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                }
                alert(errorMsg);
            };

            // TTS ì‹œì‘
            try {
                synth.speak(utterance);
                console.log('synth.speak() í˜¸ì¶œ ì™„ë£Œ');
            } catch (e) {
                console.error('synth.speak() ì˜¤ë¥˜:', e);
                alert('ìŒì„± ì¬ìƒì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message);
                stop();
            }
        }

        function stop() {
            synth.cancel();
            isSpeaking = false;
            
            if (animationInterval) {
                clearTimeout(animationInterval);
                animationInterval = null;
            }
            
            currentMouthIndex = phonemeMap['rest'];
            drawCurrentMouth();
            
            updateStatus('ëŒ€ê¸° ì¤‘...', 'idle');
            document.getElementById('speakBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${className}`;
        }

        document.getElementById('textInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                speak();
            }
        });

        // ì˜¤ë””ì˜¤ ë…¹ìŒ ê¸°ëŠ¥
        async function toggleAudioRecording() {
            if (!isAudioRecording) {
                await startAudioRecording();
            } else {
                stopAudioRecording();
            }
        }

        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                audioRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                audioRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processAudioToText(audioBlob);
                    
                    // ìŠ¤íŠ¸ë¦¼ ì •ì§€
                    stream.getTracks().forEach(track => track.stop());
                };
                
                // ì˜¤ë””ì˜¤ ì‹œê°í™” ì„¤ì •
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                document.getElementById('audioVisualizer').style.display = 'block';
                drawVisualizer();
                
                audioRecorder.start();
                isAudioRecording = true;
                
                const recordBtn = document.getElementById('audioRecordBtn');
                recordBtn.textContent = 'â¹ï¸ ë…¹ìŒ ì¤‘ì§€';
                recordBtn.classList.add('recording');
                
                updateStatus('ğŸ¤ ìŒì„± ë…¹ìŒ ì¤‘...', 'audio-recording');
                
            } catch (error) {
                console.error('ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                alert('ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        function stopAudioRecording() {
            if (audioRecorder && isAudioRecording) {
                audioRecorder.stop();
                isAudioRecording = false;
                
                const recordBtn = document.getElementById('audioRecordBtn');
                recordBtn.textContent = 'ğŸ¤ ìŒì„± ë…¹ìŒ ì‹œì‘';
                recordBtn.classList.remove('recording');
                
                document.getElementById('audioVisualizer').style.display = 'none';
                
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                
                if (audioContext) {
                    audioContext.close();
                }
                
                updateStatus('ğŸ”„ ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ ì¤‘...', 'idle');
            }
        }

        function drawVisualizer() {
            const visualizerCanvas = document.getElementById('visualizerCanvas');
            const canvasCtx = visualizerCanvas.getContext('2d');
            
            visualizerCanvas.width = visualizerCanvas.offsetWidth;
            visualizerCanvas.height = visualizerCanvas.offsetHeight;
            
            function draw() {
                if (!isAudioRecording) return;
                
                animationFrameId = requestAnimationFrame(draw);
                
                analyser.getByteFrequencyData(dataArray);
                
                canvasCtx.fillStyle = '#f0f0f0';
                canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                
                const barWidth = (visualizerCanvas.width / dataArray.length) * 2.5;
                let x = 0;
                
                for (let i = 0; i < dataArray.length; i++) {
                    const barHeight = (dataArray[i] / 255) * visualizerCanvas.height;
                    
                    const gradient = canvasCtx.createLinearGradient(0, 0, 0, visualizerCanvas.height);
                    gradient.addColorStop(0, '#ff9500');
                    gradient.addColorStop(1, '#ff6b00');
                    
                    canvasCtx.fillStyle = gradient;
                    canvasCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }
            
            draw();
        }

        async function processAudioToText(audioBlob) {
            try {
                // Web Speech APIì˜ SpeechRecognition ì‚¬ìš©
                const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'ko-KR';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                // ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒí•˜ë©´ì„œ ì¸ì‹
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('textInput').value = transcript;
                    updateStatus('âœ… ìŒì„±ì´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'idle');
                    console.log('ì¸ì‹ëœ í…ìŠ¤íŠ¸:', transcript);
                };
                
                recognition.onerror = (event) => {
                    console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                    updateStatus('âŒ ìŒì„± ì¸ì‹ ì‹¤íŒ¨. ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', 'idle');
                };
                
                recognition.start();
                audio.play();
                
            } catch (error) {
                console.error('ìŒì„± ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                updateStatus('âŒ ìŒì„± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'idle');
            }
        }

        // ì´ˆê¸° ìº”ë²„ìŠ¤
        ctx.fillStyle = '#00ff00';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    </script>
</body>
</html>
